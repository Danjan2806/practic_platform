{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è ‚Äî DSTU Hotel{% endblock %}

{% block content %}
<div id="search-popup" class="search-popup-overlay">
  <div class="search-popup-box">
    <span class="search-popup-close" onclick="closeSearchPopup()">&times;</span>
    <h3>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è –≤ {{ hotel_name }}</h3>
    
    <form method="get" class="search-popup-form">
      <label>–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞:</label>
      <input type="date" name="check_in" value="{{ check_in|default:today }}" min="{{ today }}" required>

      <label>–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞:</label>
      <input type="date" name="check_out" value="{{ check_out|default:today }}" min="{{ today }}" required>

      <label>–ì–æ—Å—Ç–µ–π:</label>
      <select name="guests">
        {% for i in 1|to_range:5 %}
          <option value="{{ i }}" {% if i == guests %}selected{% endif %}>{{ i }} –≥–æ—Å—Ç{% if i == 1 %}—å {% else %}–µ–π {% endif %}</option>
        {% endfor %}
      </select>

      <button type="submit">–ù–∞–π—Ç–∏</button>
    </form>
  </div>
</div>

<div class="date-toolbar">
  <div class="date-summary">
    <div class="check-in">
      <p class="label">–ó–∞–µ–∑–¥</p>
      <p class="date">{{ check_in|date:"j E Y" }}, {{ check_in_time|default:"—Å 14:00" }}</p>
    </div>
    <div class="check-out">
      <p class="label">–í—ã–µ–∑–¥</p>
      <p class="date">{{ check_out|date:"j E Y" }}, {{ check_out_time|default:"–¥–æ 12:00" }}</p>
    </div>
  </div>

  <button class="open-search-btn" onclick="openSearchPopup()">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
</div>


<div class="container">
  <h1>–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</h1>
  <div class="rooms-grid">
    {% for room_type in available_room_types %}
      <div class="room-block">
        <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å (–ø—Ä–µ–≤—å—é + –ø–æ–ø–∞–ø) -->
        <div class="room-photo" onclick="openPopup('{{ room_type.id }}')">
          {% if room_type.main_image %}
            <img src="{{ room_type.main_image.url }}" alt="{{ room_type.name }}">
          {% else %}
            <img src="{% static 'images/default-room.jpg' %}" alt="–ë–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
          {% endif %}
          <p class="room-name">{{ room_type.name }}</p>
          <p>{{ room_type.description }}</p>
          <ul class="room-features">
            {% for conv in room_type.conveniences.all|slice:":4" %}
              <li><i class="{{ conv.icon }}"></i> {{ conv.name }}</li>
            {% endfor %}
          </ul>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å (—Ç–∞—Ä–∏—Ñ—ã) -->
        <div class="room-tariffs">
          {% for tariff in room_type.tariffs.all %}
          <div class="tariff-card">
            <ul>
              <li>üõè {{ tariff.get_bed_type_display }}</li>  {# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–æ–≤–∞—Ç–∏ –∏–∑ choices #}
              <li>
                {% if tariff.includes_breakfast %}
                  üçΩ –ó–∞–≤—Ç—Ä–∞–∫ –≤–∫–ª—é—á—ë–Ω
                {% else %}
                  üçΩ –ë–µ–∑ –∑–∞–≤—Ç—Ä–∞–∫–∞
                {% endif %}
              </li>
              <li>‚ùå {{ tariff.cancellation }}</li>
              <li>
                {% if tariff.payment_in_advance %}
                  üí≥ –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞
                {% else %}
                  üíµ –û–ø–ª–∞—Ç–∞ –Ω–∞ –º–µ—Å—Ç–µ
                {% endif %}
              </li>
            </ul>
            <div class="tariff-label">{{ tariff.title }}</div>
            <div class="tariff-price">{{ tariff.price_per_night|floatformat:"0" }} ‚ÇΩ</div>
            <div class="tariff-note">–∑–∞ –Ω–æ—á—å</div>
            <a class="tariff-book" 
              href="#" 
              onclick="handleBookingClick(event, '{{ room_type.id }}', '{{ tariff.id }}')">
              –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
            </a>
          </div>
          {% endfor %}
        </div>
      </div>
      <!-- –ü–æ–ø–∞–ø (–≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞) -->
<div id="popup-{{ room_type.id }}" class="popup-overlay" onclick="closePopup(event, '{{ room_type.id }}')">
  <div class="popup-box" onclick="event.stopPropagation()">

    <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: —Ñ–æ—Ç–æ -->
    <div class="popup-left">
      <div class="popup-images">
        {% for img in room_type.images.all %}
          <img src="{{ img.image.url }}" alt="–§–æ—Ç–æ {{ forloop.counter }}">
        {% endfor %}
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: —É–¥–æ–±—Å—Ç–≤–∞ –∏ —Ç–∞—Ä–∏—Ñ -->
    <div class="popup-right">
      <h2>{{ room_type.name }}</h2>

      <div class="popup-conveniences">
        <h4>–£–¥–æ–±—Å—Ç–≤–∞:</h4>
        <ul>
          {% for conv in room_type.conveniences.all %}
              <li><i class="{{ conv.icon }}"></i> {{ conv.name }}</li>
            {% endfor %}
        </ul>
      </div>
          {% with room_type.tariffs.all|dictsort:"price_per_night" as sorted_tariffs %}
            {% if sorted_tariffs %}
              {% with sorted_tariffs.0 as cheapest %}
                {% if cheapest.id %}
                <div class="popup-tariff">
                  <p><strong>{{ cheapest.title }}</strong></p>
                  <p>–¶–µ–Ω–∞: {{ cheapest.price_per_night|floatformat:"0" }} ‚ÇΩ/–Ω–æ—á—å</p>
                  <p>
                    {% if cheapest.includes_breakfast %}
                      üçΩ –ó–∞–≤—Ç—Ä–∞–∫ –≤–∫–ª—é—á—ë–Ω
                    {% else %}
                      üçΩ –ë–µ–∑ –∑–∞–≤—Ç—Ä–∞–∫–∞
                    {% endif %}
                  </p>
                  <p>‚ùå {{ cheapest.cancellation }}</p>
                  <p>
                    {% if cheapest.payment_in_advance %}
                      üí≥ –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞
                    {% else %}
                  üíµ –û–ø–ª–∞—Ç–∞ –Ω–∞ –º–µ—Å—Ç–µ
                    {% endif %}
                  </p>
                    <a class="tariff-book" 
                      href="#" 
                      onclick="handleBookingClick(event, '{{ room_type.id }}', '{{ cheapest.id }}')">
                      –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                    </a>
                </div>
                {% endif %}
              {% endwith %}
            {% endif %}
          {% endwith %}
        </div>
        <span class="popup-close" onclick="closePopup(event, '{{ room_type.id }}')">&times;</span>
      </div>
    </div>
    {% endfor %}
    <a href="{% url 'rooms' %}">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –Ω–æ–º–µ—Ä–∞</a></li>
  </div>
</div>

<script>
  function handleBookingClick(event, roomTypeId, tariffId) {
    event.preventDefault();

    // –ü–æ–ª—É—á–∞–µ–º –∏ —á–∏—Å—Ç–∏–º –∑–Ω–∞—á–µ–Ω–∏—è
    const checkIn = localStorage.getItem('check_in')?.trim();
    const checkOut = localStorage.getItem('check_out')?.trim();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–¥–∞–Ω—ã –ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞—Ç—ã
    if (!checkIn || !checkOut || checkIn === 'undefined' || checkOut === 'undefined' || checkIn === 'null' || checkOut === 'null') {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã –∑–∞–µ–∑–¥–∞ –∏ –≤—ã–µ–∑–¥–∞ –ø–µ—Ä–µ–¥ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º.");
      return;
    }

    // –í—Å—ë –æ–∫ ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ —Å—Å—ã–ª–∫–µ
    const url = `/account/order/create/${roomTypeId}/${tariffId}/?check_in=${checkIn}&check_out=${checkOut}`;
    window.location.href = url;
  }

  function openPopup(id) {
    document.getElementById('popup-' + id).style.display = 'flex';
  }

  function closePopup(event, id) {
    document.getElementById('popup-' + id).style.display = 'none';
  }

  function openSearchPopup() {
    document.getElementById('search-popup').style.display = 'flex';
    const form = document.querySelector('.search-popup-form');
    form.querySelector('input[name="check_in"]').value = form.querySelector('input[name="check_in"]').value || localStorage.getItem('check_in');
    form.querySelector('input[name="check_out"]').value = form.querySelector('input[name="check_out"]').value || localStorage.getItem('check_out');
    form.querySelector('select[name="guests"]').value = form.querySelector('select[name="guests"]').value || localStorage.getItem('guests');
  }

  function closeSearchPopup() {
    document.getElementById('search-popup').style.display = 'none';
  }

  // –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ localStorage
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector('.search-popup-form');
    if (form) {
      form.addEventListener('submit', function () {
        const checkIn = form.querySelector('input[name="check_in"]').value;
        const checkOut = form.querySelector('input[name="check_out"]').value;
        const guests = form.querySelector('select[name="guests"]').value;

        localStorage.setItem('check_in', checkIn);
        localStorage.setItem('check_out', checkOut);
        localStorage.setItem('guests', guests);
      });
    }
  });
</script>
{% endblock %}