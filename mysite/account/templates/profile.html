{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
  <a href="/" class="back-arrow">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
  <div class="tabs" style="display: flex; gap: 20px; margin-bottom: 25px;">
  <a href="{% url 'profile' %}" 
     class="tab-button {% if request.resolver_match.url_name == 'profile' %}active-tab{% endif %}">
     üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã
  </a>
  <a href="{% url 'analytics' %}" 
     class="tab-button {% if request.resolver_match.url_name == 'analytics' %}active-tab{% endif %}">
     üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
  </a>
</div>
  <h1>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h1>
  <div class="sort-buttons-container" style="display: flex; gap: 20px; margin-bottom: 20px;">
    <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ –∑–∞–µ–∑–¥–∞ -->
    <div class="sort-dropdown">
      <button class="sort-btn" data-dropdown="date-dropdown">
        –î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞
        <span>‚ñº</span>
      </button>
      <ul class="dropdown-menu" id="date-dropdown">
        <li data-sort="check_in">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</li>
        <li data-sort="-check_in">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</li>
      </ul>
    </div>

    <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ü–µ–Ω–µ -->
    <div class="sort-dropdown">
      <button class="sort-btn" data-dropdown="price-dropdown">
        –¶–µ–Ω–∞
        <span>‚ñº</span>
      </button>
      <ul class="dropdown-menu" id="price-dropdown">
        <li data-sort="total_price">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</li>
        <li data-sort="-total_price">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</li>
      </ul>
    </div>

    <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–µ–∑–¥–∞ -->
    <div class="sort-dropdown">
      <button class="sort-btn" data-dropdown="arrival-dropdown">
        –í—Ä–µ–º—è –∑–∞–µ–∑–¥–∞
        <span>‚ñº</span>
      </button>
      <ul class="dropdown-menu" id="arrival-dropdown">
        <li data-sort="arrival_time">–°–Ω–∞—á–∞–ª–∞ —Ä–∞–Ω–Ω–∏–µ</li>
        <li data-sort="-arrival_time">–°–Ω–∞—á–∞–ª–∞ –ø–æ–∑–¥–Ω–∏–µ</li>
      </ul>
    </div>

    <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–∞—Ä–∏—Ñ—É -->
    <div class="sort-dropdown">
      <button class="sort-btn" data-dropdown="tariff-dropdown">
        –¢–∞—Ä–∏—Ñ
        <span>‚ñº</span>
      </button>
      <ul class="dropdown-menu" id="tariff-dropdown">
        <li data-sort="tariff">–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É –ê-–Ø</li>
        <li data-sort="-tariff">–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É –Ø-–ê</li>
      </ul>
    </div>
  </div>
  {% if orders %}
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 4px 14px rgba(0,0,0,0.07); border-radius: 12px; overflow: hidden; font-size: 15px;">
        <thead style="background: #d4e4fa;">
          <tr>
            <th style="border: 1px solid #ccc; padding: 12px; text-align: left;">–ù–æ–º–µ—Ä</th>
            <th style="border: 1px solid #ccc; padding: 12px; text-align: left;">–¢–∞—Ä–∏—Ñ</th>
            <th style="border: 1px solid #ccc; padding: 12px; text-align: left; min-width: 180px;">–î–∞—Ç—ã</th>
            <th style="border: 1px solid #ccc; padding: 12px; text-align: left;">–¶–µ–Ω–∞</th>
            <th style="border: 1px solid #ccc; padding: 12px; text-align: left;">–£–¥–æ–±—Å—Ç–≤–∞</th>
            <th style="border: 1px solid #ccc; padding: 12px; text-align: left;">–ü–æ–∂–µ–ª–∞–Ω–∏—è</th>
            <th style="border: 1px solid #ccc; padding: 12px; text-align: left;">–í—Ä–µ–º—è –∑–∞–µ–∑–¥–∞</th>
            <th style="border: 1px solid #ccc; padding: 12px; text-align: left;">–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
            <th style="border: 1px solid #ccc; padding: 12px; text-align: left;">–ß–µ–∫</th>
            <th style="border: 1px solid #ccc; padding: 12px; text-align: left;">–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
            <tr style="background: {% cycle '#ffffff' '#f5f7fa' %};">
              <td style="border: 1px solid #ddd; padding: 12px;">{{ order.room.room_type.name }}</td>
              <td style="border: 1px solid #ddd; padding: 12px;">{{ order.tariff.title }}</td>
              <td style="border: 1px solid #ddd; padding: 12px; white-space: nowrap;">
                {{ order.check_in }} ‚Äî {{ order.check_out }}
              </td>
              <td style="border: 1px solid #ddd; padding: 12px;">{{ order.total_price }} ‚ÇΩ</td>
              <td style="border: 1px solid #ddd; padding: 12px;">
                {% if order.conveniences.all %}
                  {% for conv in order.conveniences.all %}
                    {{ conv.name }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                {% else %}
                  {% for conv in order.room.room_type.conveniences.all %}
                    {{ conv.name }}{% if not forloop.last %}, {% endif %}
                  {% empty %}
                    ‚Äî
                  {% endfor %}
                {% endif %}
              </td>
              <td style="border: 1px solid #ddd; padding: 12px;">{{ order.wishes|default:"‚Äî" }}</td>
              <td style="border: 1px solid #ddd; padding: 12px;">{{ order.arrival_time|default:"‚Äî" }}</td>
              <td style="border: 1px solid #ddd; padding: 12px;">
                {{ order.creator.user.get_full_name }}<br>
                {{ order.creator.user.email }}<br>
                {{ order.creator.phone_number }}
              </td>
              <td style="border: 1px solid #ddd; padding: 12px;">
                {% if order.receipt_file %}
                  <a href="{% url 'download_receipt' order.id %}" target="_blank" rel="noopener noreferrer">–°–∫–∞—á–∞—Ç—å</a>
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
              <td style="border: 1px solid #ddd; padding: 12px;">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                  <a href="{% url 'order_edit' order.id %}" class="save-btn" style="padding: 6px 10px; font-size: 14px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                  <button class="delete-btn" data-order-id="{{ order.id }}" style="padding: 6px 10px; font-size: 14px;">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</p>
  {% endif %}
</div>
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="popup_3-overlay hidden" id="deletePopup">
  <div class="popup_3-box">
    <span class="close-btn" id="deleteClose">&times;</span>
    <h3>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?</h3>
    <p>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
    <div class="popup_3-buttons">
      <form id="deleteForm" method="post">
        {% csrf_token %}
        <button type="submit">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
        <button type="button" id="deleteCancel">–û—Ç–º–µ–Ω–∞</button>
      </form>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // -----------------------------
  // 1Ô∏è‚É£ –ú–æ–¥–∞–ª–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
  const deleteButtons = document.querySelectorAll('.delete-btn');
  const deletePopup = document.getElementById('deletePopup');
  const deleteClose = document.getElementById('deleteClose');
  const deleteCancel = document.getElementById('deleteCancel');
  const deleteForm = document.getElementById('deleteForm');

  if (deleteButtons.length && deletePopup && deleteClose && deleteCancel && deleteForm) {
    deleteButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const orderId = btn.dataset.orderId;
        deleteForm.action = `/account/order/${orderId}/delete/`;
        deletePopup.style.display = 'flex';
      });
    });


    const closePopup = () => { deletePopup.style.display = 'none'; };
    deleteClose.addEventListener('click', closePopup);
    deleteCancel.addEventListener('click', closePopup);
    deletePopup.addEventListener('click', e => { if (e.target === deletePopup) closePopup(); });
  }

  // -----------------------------
  // 2Ô∏è‚É£ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞–∫–∞–∑–æ–≤
  const currentSort = '{{ current_sort|default:"-check_in" }}';
  const dropdowns = document.querySelectorAll('.sort-dropdown');

  dropdowns.forEach(dropdown => {
    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞
    dropdown.querySelectorAll('li').forEach(item => {
      if (item.getAttribute('data-sort') === currentSort) {
        item.style.fontWeight = '700';
        item.style.color = '#004AAD';
      }
    });

    const btn = dropdown.querySelector('.sort-btn');
    const menu = dropdown.querySelector('.dropdown-menu');

    btn.addEventListener('click', e => {
      e.stopPropagation();
      dropdowns.forEach(d => { if (d !== dropdown) d.classList.remove('open'); });
      dropdown.classList.toggle('open');
    });

    menu.querySelectorAll('li').forEach(item => {
      item.addEventListener('click', () => {
        const sortValue = item.getAttribute('data-sort');
        const url = new URL(window.location.href);
        url.searchParams.set('sort', sortValue);
        window.location.href = url.toString();
      });
    });
  });

  // –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
  document.addEventListener('click', () => {
    dropdowns.forEach(d => d.classList.remove('open'));
  });
});
</script>
{% endblock %}
